---
title: "Fatty Acid Retention Time Prediction"
author: "RLionheart"
date: "2/3/2020"
output: html_document
---

This markdown script controls the procedure for predicting the retention times of targeted fatty acids run on the QExactive Mass Spectrometer.

*FIX THIS*
It contains four major sections:
Section I: Import and cleaning/rearranging of data.
Section II: Quality control using user-defined parameters.


```{r setup, include = TRUE}
knitr::opts_chunk$set(echo = TRUE)

#library(ggplot2)
library(plotly)
library(reshape2)
#library(rlist)
#library(stringr)
library(tidyverse)
#library(tidyr)
options(scipen=999)

source("src/FA_functions.R")

processed.folder <- "data_processed" 
figures.folder <- "figures"
intermediate.folder <- "data_intermediate"
dir.create(file.path(".", processed.folder))  
dir.create(file.path(".", figures.folder))  
dir.create(file.path(".", intermediate.folder))  

if (length(dir(path = "data_processed/")) == 0) {
  cat("\nData_processed subdirectory has been created and is ready for new data.")
} else {
  cat("Warning: data_processed subdirectory is not empty. Empty contents before continuing.\n")
}
```


If you would like to empty the data_processed/, data_intermediate, and figures/ subdirectories, run the following code.
```{r, include = TRUE}
toClear <- c("data_processed/", "data_intermediate", "figures/")
f <- list.files(toClear, include.dirs = F, full.names = T, recursive = T)
file.remove(f)

print("Subdirectories emptied.")
```

----------------------------------------------------------------------------------------------------------------------------

Section I: Import all MSDial files that have been split by Area, Mass/charge (Mz), Retention Time (RT), and Signal to Noise (SN).

In the MSDial datasets:
Set header, filter unknowns.
Change variable classes from character/factor to numeric.
Rearrange the dataframes and combine to a single frame in long format.
Standardize dataset by removing "Ingalls_" prefixes from compound names, and removing the syntactically correct "X" from Replicates.

***
Inputs: 
"data_raw/*file.pattern*.csv
Outputs: 
"data_intermediates/MSDial_combined_*file.pattern*_*DATE*.csv"
***

*User action required*
Enter the file.pattern and matching.pattern required for your files. 
The file.pattern variable should be a character string that applies to all the MSDial files from your run.
The matching.pattern variable helps the program 

```{r Pattern matching, include = TRUE}
file.pattern <- "FA"
matching.pattern <- "FA.data"

print(paste("Your file pattern is:", file.pattern))
```

```{r MSDial Imports, include = TRUE}
source("src/MSDial_Import.R")

print("Required files imported.")
```

*User action required*
Enter the existing filenames of your run. The above code assigns the variables in R to their filename in the directory, so if your positive Area file is "data_raw/PositiveArea.csv", it will be imported to this code as PositiveArea. Those files need to be reassigned to the given variables so the rest of the code will know which files to edit for the pipeline steps.

Comment or uncomment the block of variable names appropriate for your run.

```{r Dataset reassignment, include = TRUE}
# Comment out the run not being used.

# Cyano variables: 
Area.FA.data <- Area_KM1906_FA_DepthProfiles
Mz.FA.data <- Mz_KM1906_FA_DepthProfiles
RT.FA.data <- RT_KM1906_FA_DepthProfiles
SN.FA.data <- SN_KM1906_FA_DepthProfiles

print(paste(file.pattern, "variables assigned."))
```

Rearrange and export.
```{r Dataset rearrangement, include = TRUE}
source("src/FA_Rearrange.R")

print("Data rearrange complete.")
```

------------------------------------------------------------------------------------------------------------------------------------------------

Section II: Use standard runs to predict shifting retention times 

In the Retention Prediction step:
Import files.
Identify run types and check if all are present (blk, smp, std, poo).


***
Inputs: 
"data_intermediate/MSDial_combined_*file.pattern*_*DATE*.csv"
"data_extras/FA_Expected_RT.csv"

Outputs: 

"data_processed/MSDial_QC_Output_*file.pattern*_*DATE*.csv"
***

```{r Import retention time files, include = TRUE}
source("src/RT_Import.R")

print("Fatty Acid data combined with expected data.")
```

Separate replicates by size fractionation.
```{r Separate size fractions, include = TRUE}
fatty.acid_0.2 <- FA.expected %>%
  filter(!str_detect(Replicate.Name, "0.3")) 

fatty.acid_0.3 <- FA.expected %>%
  filter(!str_detect(Replicate.Name, "0.2")) 

print("Split by size fractionation.")
```


```{r Create random values for experimentation, include = TRUE}
# Create random values
dummy.data <- fatty.acid_0.2 %>%
  group_by(Metabolite.Name, Replicate.Name) %>%
  mutate(Random.RT = runif(1, RT.Value, RT.Value + 1)) %>%
  group_by(Metabolite.Name) %>%
  mutate(Random.Mean = mean(Random.RT)) %>%
  select(Replicate.Name:RT.Expected, Mean.RT.Value, Random.RT, Random.Mean, Cmpd.with.Std)

```


First plot of retention times  
```{r Retention time plot, include = TRUE}
real.RT.plot <- ggplot(fatty.acid_0.2, aes(x = Metabolite.Name, y = Mean.RT.Value, fill = Cmpd.with.Std)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(aes(label = round(Mean.RT.Value, digits = 2)), 
            position=position_dodge(width=0.9), 
            vjust=-0.25, size = 2.5) +
  theme(axis.text.x = element_text(angle = 90, size = 10),
        axis.text.y = element_text(size = 10),
        legend.position = "top",
        strip.text = element_text(size = 10)) +
ggtitle("Fatty Acids: 0.2 Size Fraction")

# And with dummy data
dummy.plot <- ggplot(dummy.data, aes(x = Metabolite.Name, y = Random.Mean, fill = Cmpd.with.Std)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(aes(label = round(Random.Mean, digits = 2)), 
            position=position_dodge(width=0.9), 
            vjust=-0.25, size = 2.5) +
  theme(axis.text.x = element_text(angle = 90, size = 10),
        axis.text.y = element_text(size = 10),
        legend.position = "top",
        strip.text = element_text(size = 10)) +
  ggtitle("Random RT Values")

require(gridExtra)
grid.arrange(real.RT.plot, dummy.plot, nrow=2)
```


Retention Time Tables 
```{r Retention time tables, include = TRUE}
real.standards <- fatty.acid_0.2 %>%
  filter(!str_detect(Replicate.Name, "IS")) %>%
  filter(str_detect(Replicate.Name, "_Std_")) %>%
  filter(str_detect(Metabolite.Name, "_Std")) %>%
  mutate(RT.Diff = RT.Value - RT.Expected) %>% 
  select(Replicate.Name, Metabolite.Name, RT.Expected, RT.Value, Mean.RT.Value:RT.Diff)

dummy.standards <- dummy.data %>%
  filter(!str_detect(Replicate.Name, "IS")) %>%
  filter(str_detect(Replicate.Name, "_Std_")) %>%
  filter(str_detect(Metabolite.Name, "_Std")) %>%
  group_by(Metabolite.Name) %>%
  mutate(Random.RT.Mean = mean(Random.RT)) 

```


Real + Dummy standards plotted 
```{r Plot real and dummy standards, include = TRUE}
std.RT.plot <- ggplot(real.standards, aes(x = Metabolite.Name, y = Mean.RT.Value, label = Mean.RT.Value)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(aes(label = round(Mean.RT.Value, digits = 2)), position=position_dodge(width=0.9), vjust=-0.25) +
  theme(axis.text.x = element_text(angle = 90, size = 10),
        axis.text.y = element_text(size = 10),
        legend.position = "top",
        strip.text = element_text(size = 10)) +
  ggtitle("Fatty Acids: Standard Compounds")

dummy.std.RT.plot <- ggplot(dummy.standards, aes(x = Metabolite.Name, y = Random.Mean)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(aes(label = round(Random.Mean, digits = 2)), position=position_dodge(width=0.9), vjust=-0.25) +
  theme(axis.text.x = element_text(angle = 90, size = 10),
        axis.text.y = element_text(size = 10),
        legend.position = "top",
        strip.text = element_text(size = 10)) +
  ggtitle("Random Standards")

stds.together <- dummy.standards %>%
  select(Metabolite.Name, Mean.RT.Value, Random.RT.Mean) %>%
  rename(Real.RT.Value = Mean.RT.Value) %>%
  rename(Random.RT.Value = Random.RT.Mean) %>%
  unique()

stds.together <- melt(stds.together) %>%
  rename(RT.Type = variable) %>%
  rename(Retention.Time = value)
stds.together.plot <- ggplot(stds.together, aes(Metabolite.Name, Retention.Time, fill = RT.Type)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme(axis.text.x = element_text(angle = 90, size = 10),
        axis.text.y = element_text(size = 10),
        legend.position = "top",
        strip.text = element_text(size = 10)) +
  ggtitle("Real vs Random Standards Retention Times")
stds.together.plot <- ggplotly(stds.together.plot)
stds.together.plot
```


Real + Dummy standards plotted
```{r High and low prediction estimate, include = TRUE}
stds.differences <- stds.together %>%
  group_by(Metabolite.Name) %>%
  mutate(Difference = abs(Retention.Time[RT.Type == "Real.RT.Value"] - Retention.Time[RT.Type == "Random.RT.Value"])) %>%
  select(Metabolite.Name, Difference) %>%
  unique() %>%
  ungroup() %>%
  mutate(Min.diff = min(Difference)) %>%
  mutate(Max.diff = max(Difference)) %>%
  select(Min.diff, Max.diff) %>%
  unique()

high.estimate <- stds.differences$Max.diff
low.estimate <- stds.differences$Min.diff
```


Combine estimates and plot
```{r Plot estimates, include = TRUE}

high.low.predictions <- fatty.acid_0.2 %>%
  select(Replicate.Name, Metabolite.Name, RT.Value) %>%
  mutate(High.RT = RT.Value + high.estimate) %>%
  mutate(Low.RT = RT.Value + low.estimate) %>%
  filter(!str_detect(Metabolite.Name, "Std|IS"))

high.low.plot.table <- melt(high.low.predictions) %>%
  rename(RT.Value.Prediction = variable) %>%
  rename(RT.Value = value)


prediction.plot <- ggplot(high.low.plot.table, aes(fill = RT.Value.Prediction, y = RT.Value, x = Metabolite.Name)) + 
  geom_bar(position="dodge", stat="identity") +
  scale_fill_manual(values=c("firebrick3", "navyblue", "skyblue")) +
  theme(axis.text.x = element_text(angle = 90, size = 10, vjust = 0.5),
        axis.text.y = element_text(size = 10),
        legend.position = "top",
        strip.text = element_text(size = 10)) + 
  ggtitle("Predicted Fatty Acid Retention Times")
prediction.plot <- ggplotly(prediction.plot)
prediction.plot
```



------------------------------------------------------------------------------------------------------------------------------------------------
